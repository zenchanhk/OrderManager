<UserControl x:Class="AmiBroker.Controllers.ScriptTabView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:e="http://schemas.microsoft.com/expression/2010/interactivity"
             xmlns:local="clr-namespace:AmiBroker.Controllers"
             xmlns:controls="clr-namespace:ControlLib"             
             xmlns:om="clr-namespace:AmiBroker.OrderManager"
             xmlns:sdl="http://schemas.sdl.com/xaml"
             xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
             Name="scriptTabView"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Resource.xaml" />
                <ResourceDictionary Source="../Styles/MultiSelectComboBox.Custom.ControlTemplate.xaml"/>
                <ResourceDictionary Source="../Styles/MultiSelectComboBox.Custom.DropdownItemTemplate.xaml"/>
                <ResourceDictionary Source="../Styles/MultiSelectComboBox.Custom.SelectedItemTemplate.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <local:CustomFilterService x:Key="CustomFilterService" />
            <local:BindingProxy x:Key="Proxy" Data="{Binding}" />
            <local:OrderTypeDetailSelector x:Key="OrderTypeDetailSelector" />
            
            <!-- IB order type settings -->
            <DataTemplate x:Key="IBOrderTypeDetail" DataType="{x:Type om:IBOrderType}">
                <StackPanel>
                    <CheckBox IsChecked="{Binding Transmit}" Margin="10,3,3,3" >
                        <TextBlock Text="Transmit immediately" />
                    </CheckBox>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                        <GroupBox HorizontalAlignment="Stretch">
                            <GroupBox.Header>
                                <CheckBox Name="chkGAT"  
                                        IsChecked="{Binding GoodAfterTime.SelectedIndex,
                                        Converter={StaticResource SelectedIndexToCheckBoxValueConverter}}" >
                                        <TextBlock Text="Options for Good After Time" />
                                </CheckBox>
                            </GroupBox.Header>
                            <Grid>
                                <StackPanel HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                                        <RadioButton VerticalAlignment="Center" GroupName="ibgat" IsChecked="{Binding GoodAfterTime.SelectedIndex, Converter={StaticResource SelectedIndexToOptionConverter}, ConverterParameter=1}">
                                            <TextBlock Text="Exact GAT" />
                                        </RadioButton>
                                        <controls:DateTimeEditor x:Name="gat_dtEditor" Value="{Binding GoodAfterTime.ExactTime}"
                                                 Format="HH:mm:ss" PreviewKeyDown="gt_PreviewKeyDown"
                                                 Width="60" Margin="4,0,2,0" />
                                        <TextBlock VerticalAlignment="Center" Text="valid in" Margin="2, 0"/>
                                        <controls:NumericUpDown x:Name="gat_ud_1" Value="{Binding GoodAfterTime.ExactTimeValidDays}"
                                                             PreviewKeyDown="gt_PreviewKeyDown" Click="gt_Click"
                                                             MinValue="0" MaxValue="10"
                                                             Width="50" Margin="2, 0" />
                                        <TextBlock VerticalAlignment="Center" Text="days"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                                        <RadioButton VerticalAlignment="Center" GroupName="ibgat" IsChecked="{Binding GoodAfterTime.SelectedIndex, Converter={StaticResource SelectedIndexToOptionConverter}, ConverterParameter=2}">
                                            <TextBlock Text="Seconds after order placed" />
                                        </RadioButton>
                                        <controls:NumericUpDown x:Name="gat_ud_sec" Value="{Binding GoodAfterTime.Seconds}"
                                                             MinValue="1" MaxValue="10000" PreviewKeyDown="gt_PreviewKeyDown"
                                                             Width="50" Margin="5, 0" Click="gt_Click" />
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                                        <RadioButton VerticalAlignment="Center" GroupName="ibgat" IsChecked="{Binding GoodAfterTime.SelectedIndex, Converter={StaticResource SelectedIndexToOptionConverter}, ConverterParameter=3}">
                                            <TextBlock Text="Bars after order placed" />
                                        </RadioButton>
                                        <controls:NumericUpDown x:Name="gat_ud_bar" Value="{Binding GoodAfterTime.Bars}"
                                                             PreviewKeyDown="gt_PreviewKeyDown" Click="gt_Click"
                                                             MinValue="1" MaxValue="100"
                                                             Width="50" Margin="5, 0" />
                                        <TextBlock Text="(1 means current bar)" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </StackPanel>
                                <StackPanel Visibility="{Binding GoodAfterTime.SelectedIndex, Converter={StaticResource SelectedIndexToVisConverter}}" 
                                            Background="DimGray" Opacity="0.8"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Stretch"
                                            />
                            </Grid>                            
                        </GroupBox>                        
                    </StackPanel>
                    
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                        <GroupBox HorizontalAlignment="Stretch">
                            <GroupBox.Header>
                                <CheckBox Name="chkGTD"  
                                        IsChecked="{Binding GoodTilDate.SelectedIndex,
                                        Converter={StaticResource SelectedIndexToCheckBoxValueConverter}}" >
                                    <TextBlock Text="Options for Good Till Date" />
                                </CheckBox>
                            </GroupBox.Header>
                            <Grid>
                                <StackPanel HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                                        <RadioButton VerticalAlignment="Center" GroupName="ibgtd" IsChecked="{Binding GoodTilDate.SelectedIndex, Converter={StaticResource SelectedIndexToOptionConverter}, ConverterParameter=1}">
                                            <TextBlock Text="Exact GTD" />
                                        </RadioButton>
                                        <controls:DateTimeEditor Value="{Binding GoodTilDate.ExactTime}"
                                                                 x:Name="gtd_dtEditor"
                                                 Format="HH:mm:ss" PreviewKeyDown="gt_PreviewKeyDown"
                                                 Width="60" Margin="4,0,2,0" />
                                        <TextBlock VerticalAlignment="Center" Text="valid in" Margin="2, 0"/>
                                        <controls:NumericUpDown Value="{Binding GoodTilDate.ExactTimeValidDays}"
                                                             PreviewKeyDown="gt_PreviewKeyDown" x:Name="gtd_ud_1" Click="gt_Click"
                                                             MinValue="0" MaxValue="10"
                                                             Width="50" Margin="2, 0" />
                                        <TextBlock VerticalAlignment="Center" Text="days"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                                        <RadioButton VerticalAlignment="Center" GroupName="ibgtd" IsChecked="{Binding GoodTilDate.SelectedIndex, Converter={StaticResource SelectedIndexToOptionConverter}, ConverterParameter=2}">
                                            <TextBlock Text="Seconds after order placed" />
                                        </RadioButton>
                                        <controls:NumericUpDown Value="{Binding GoodTilDate.Seconds}"
                                                             MinValue="1" MaxValue="10000" x:Name="gtd_ud_sec"
                                                             PreviewKeyDown="gt_PreviewKeyDown" Click="gt_Click"
                                                             Width="50" Margin="5, 0" />
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                                        <RadioButton VerticalAlignment="Center" GroupName="ibgtd" IsChecked="{Binding GoodTilDate.SelectedIndex, Converter={StaticResource SelectedIndexToOptionConverter}, ConverterParameter=3}">
                                            <TextBlock Text="Bars after order placed" />
                                        </RadioButton>
                                        <controls:NumericUpDown Value="{Binding GoodTilDate.Bars}"
                                                             PreviewKeyDown="gt_PreviewKeyDown" x:Name="gtd_ud_bar"
                                                             MinValue="1" MaxValue="100" Click="gt_Click"
                                                             Width="50" Margin="5, 0" />
                                        <TextBlock Text="(1 means current bar)" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </StackPanel>
                                <StackPanel Visibility="{Binding GoodTilDate.SelectedIndex, Converter={StaticResource SelectedIndexToVisConverter}}" 
                                            Background="DimGray" Opacity="0.8"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Stretch"
                                            />
                            </Grid>
                        </GroupBox>
                    </StackPanel>
                    <StackPanel HorizontalAlignment="Stretch" Margin="10,3,3,3">
                        <TextBlock VerticalAlignment="Center" Text="Slippage: " />
                        <controls:SlippageListView ItemsSource="{Binding Slippages}" Margin="0, 1"/>
                    </StackPanel>
                    <StackPanel Margin="10,3,3,3"
                                Visibility="{Binding DataContext.SelectedItem, ElementName=scriptTabView, Converter={StaticResource TypeToVisConverter}}">
                        <xctk:PropertyGrid IsManipulationEnabled="True" ShowSearchBox="False"
                                           AutoGenerateProperties="False"
                                           ShowSortOptions="False" ShowTitle="False"
                                           ShowSummary="False"
                                           ShowPreview="False"
                                           ShowDescriptionByTooltip="False"
                                           SelectedObject="{Binding Converter={StaticResource TypeToPGObjectConverter}}" >
                            <xctk:PropertyGrid.PropertyDefinitions>
                                <xctk:PropertyDefinition TargetProperties="LmtPrice" />
                                <xctk:PropertyDefinition TargetProperties="AuxPrice" />
                                <xctk:PropertyDefinition TargetProperties="TrailingPercent" />
                                <xctk:PropertyDefinition TargetProperties="TrailStopPrice" />
                                <xctk:PropertyDefinition TargetProperties="PositionSize" />
                            </xctk:PropertyGrid.PropertyDefinitions>
                        </xctk:PropertyGrid>
                    </StackPanel>
                    <StackPanel Margin="10,3,3,3">
                        <GroupBox Header="Description">
                            <TextBlock Text="{Binding Description}"
                                       TextWrapping="Wrap"/>
                        </GroupBox>
                    </StackPanel>

                </StackPanel>
            </DataTemplate>
            <!-- end of IB order type settings -->
            
            <DataTemplate x:Key="FTOrderTypeDetail" DataType="{x:Type om:FTOrderType}">
                <StackPanel>
                    <TextBlock Text="Under Construction" />
                </StackPanel>
            </DataTemplate>
            
            <!--DataTemplate for SymbolInAction-->
            <DataTemplate x:Key="DTforSymbolInAction" DataType="{x:Type om:SymbolInAction}" >
                <StackPanel>
                    <!-- header -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="3" DockPanel.Dock="Left">
                        <Image Source="{StaticResource optionDrawingImage}" Width="24" />
                        <TextBlock FontSize="16" Margin="5,0,0,0" >
                                    <Run Text="Options for contract: " />
                                    <Bold><Run Text="{Binding Path=Name, Mode=OneWay}" /></Bold>
                        </TextBlock>
                    </StackPanel>
                    
                    <StackPanel HorizontalAlignment="Stretch" Margin="3" Background="LightGray">
                        <TextBlock Text="Selecting TimeZone" Margin="3" FontWeight="Bold"/>
                    </StackPanel>

                    <StackPanel Margin="5" Orientation="Horizontal">
                        <TextBlock VerticalAlignment="Center" Text="TimeZone:" Margin="3,0" />
                        <ComboBox ItemsSource="{Binding DataContext.TimeZones, ElementName=scriptTabView}"
                                  SelectedItem="{Binding TimeZone}"
                                  Width="350"
                                  />
                    </StackPanel>

                    <StackPanel HorizontalAlignment="Stretch" Margin="3" Background="LightGray">
                        <TextBlock Text="Symbol Details" Margin="3" FontWeight="Bold"/>
                    </StackPanel>
                    <StackPanel Margin="5">
                        <xctk:PropertyGrid IsManipulationEnabled="True" ShowSearchBox="False"
                                               AutoGenerateProperties="False"
                                               ShowSortOptions="False" ShowTitle="False"
                                               ShowSummary="False" ShowPreview="False"
                                               ShowDescriptionByTooltip="False"
                                               SelectedObject="{Binding}" >
                            <xctk:PropertyGrid.PropertyDefinitions>
                                <xctk:PropertyDefinition TargetProperties="MinTick" />
                                <xctk:PropertyDefinition TargetProperties="RoundLotSize" />
                                <xctk:PropertyDefinition TargetProperties="MinOrderSize" />
                                <xctk:PropertyDefinition TargetProperties="MaxOrderSize" />
                            </xctk:PropertyGrid.PropertyDefinitions>
                        </xctk:PropertyGrid>
                    </StackPanel>
                    
                    <StackPanel HorizontalAlignment="Stretch" Margin="3" Background="LightGray">
                        <TextBlock Text="Symbol Definition" Margin="3" FontWeight="Bold"/>
                    </StackPanel>
                    <DockPanel HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Height="120" LastChildFill="True" Margin="5">
                        <ListView ItemsSource="{Binding SymbolDefinition}" 
                                      ItemContainerStyle="{StaticResource GridLineStyle}">
                            <ListView.View>
                                <GridView>
                                    <!--GridViewColumn Header="Vendor" Width="150" DisplayMemberBinding="{Binding Controller.Vendor, Converter={StaticResource TypeToStaticMemberConverter}, ConverterParameter=VendorFullName }" /-->
                                    <GridViewColumn Header="Vendor" Width="150" DisplayMemberBinding="{Binding Controller.VendorFullName}" />
                                    <GridViewColumn Header="Symbol Definition" Width="150">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBox Text="{Binding ContractId}" Width="145" BorderThickness="0" />
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Local Symbol" Width="150" DisplayMemberBinding="{Binding LocalSymbol}"/>
                                </GridView>
                            </ListView.View>
                        </ListView>
                    </DockPanel>

                    <StackPanel HorizontalAlignment="Stretch" Margin="3" Background="LightGray">
                        <TextBlock Text="Selecting Accounts" Margin="3" FontWeight="Bold"/>
                    </StackPanel>
                    <DockPanel HorizontalAlignment="Stretch" VerticalAlignment="Stretch" LastChildFill="True" Margin="5">
                        <ListView Name="lv" ItemsSource="{Binding DataContext.Controllers, ElementName=scriptTabView}" 
                                          ItemContainerStyle="{StaticResource GridLineStyle}"   
                                          >
                            <ListView.View>
                                <GridView>
                                    <GridViewColumn Header="Select" Width="40">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <DockPanel HorizontalAlignment="Stretch">
                                                    <!--
                                                            <CheckBox Name="chk1" HorizontalAlignment="Center"                                                                  
                                                                      local:BindableParameter.BindParameter="{local:BindableParameter TargetProperty=CheckBox.IsChecked,
                                                                Binding={Binding Path=.}, Binding1={Binding Path=., ElementName=scriptTabView}, 
                                                                MVConvert={StaticResource CombinedConverter}}"
                                                                      IsChecked="{Binding DataContext.SelectedItem.AppliedControllers, ElementName=scriptTabView,
                                                                Converter={StaticResource SelectedToCollectionConverter}}">
                                                            </CheckBox>-->

                                                    <CheckBox HorizontalAlignment="Center">
                                                        <CheckBox.IsChecked>
                                                            <local:BcpBinding 
                                                                            Path="DataContext.Dummy"
                                                                            ElementName="scriptTabView"
                                                                            ConverterParameters="Binding ElementName=scriptTabView Path=DataContext, Binding Path=. "
                                                                            Converter="{StaticResource SelectedToCollectionConverter}"
                                                                            Mode="TwoWay" />
                                                        </CheckBox.IsChecked>
                                                    </CheckBox>
                                                </DockPanel>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Status" Width="40">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <DockPanel HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                                                    <local:IconBlock HorizontalAlignment="Center" 
                                                                             Icon="Circle" 
                                                                             Foreground="{Binding ConnectionStatus, Converter={StaticResource StatusToBrushConverter}}" />
                                                </DockPanel>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Name" Width="150" DisplayMemberBinding="{Binding DisplayName}" />
                                    <GridViewColumn Header="Account Details" Width="450" >
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <ItemsControl ItemsSource="{Binding Accounts}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <StackPanel Orientation="Horizontal" />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <TextBlock Margin="0,0,3,0">
                                                                        <Run Text="["/>
                                                                        <Bold><Run Text="{Binding Name, Mode=OneWay}" /></Bold>
                                                                        <Run Text="]"/>
                                                                        <Run Text="{Binding TotalCashValue.Currency}" />
                                                                        <Run Text="{Binding TotalCashValue.Value}" />
                                                            </TextBlock>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>

                                        <GridViewColumn.HeaderContainerStyle>
                                            <Style TargetType="{x:Type GridViewColumnHeader}">
                                                <Setter Property="HorizontalContentAlignment" Value="Left" />
                                                <Setter Property="Margin" Value="2, 0,0,0" />
                                            </Style>
                                        </GridViewColumn.HeaderContainerStyle>
                                    </GridViewColumn>
                                </GridView>
                            </ListView.View>
                        </ListView>
                    </DockPanel>
                </StackPanel>
            </DataTemplate>
            <!--End of DataTemplate for SymbolInAction-->
            
            <!-- Base dataTemplate for Script/Strategy-->
            <DataTemplate x:Key="base" >
                <StackPanel>
                    <StackPanel HorizontalAlignment="Stretch" Margin="3" Background="LightGray">
                        <TextBlock Text="Entry Options" Margin="3" FontWeight="Bold"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                        <TextBlock VerticalAlignment="Center" Text="Max. open positions: " />
                        <controls:NumericUpDown Value="{Binding MaxOpenPosition}" 
                                    MinValue="1" Increment="1" Margin="5, 0" Width="70"
                                    MaxValue="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                    Converter={StaticResource ParentValueToMaxValueConverter},
                                    ConverterParameter=MaxOpenPosition$3000}" />                        
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                        <TextBlock VerticalAlignment="Center" Text="Max. LONG open positions: " />
                        <controls:NumericUpDown Value="{Binding MaxLongOpenPosition}" 
                                    MinValue="1" Increment="1" Margin="5, 0" Width="70"
                                    MaxValue="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                    Converter={StaticResource ParentValueToMaxValueConverter},
                                    ConverterParameter=MaxOpenPosition$1000}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                        <TextBlock VerticalAlignment="Center" Text="Max. SHORT open positions: " />
                        <controls:NumericUpDown Value="{Binding MaxShortOpenPosition}" 
                                    MinValue="1" Increment="1" Margin="5, 0" Width="70"
                                    MaxValue="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                    Converter={StaticResource ParentValueToMaxValueConverter},
                                    ConverterParameter=MaxOpenPosition$1000}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                        <TextBlock VerticalAlignment="Center" Text="Max. entries per day: " />
                        <controls:NumericUpDown Value="{Binding MaxEntriesPerDay}" 
                                    MinValue="1" Increment="1" Margin="5, 0" Width="70"
                                    MaxValue="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                    Converter={StaticResource ParentValueToMaxValueConverter},
                                    ConverterParameter=MaxEntriesPerDay$1000}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3"
                                Visibility="{Binding DataContext.SelectedItem, ElementName=scriptTabView, Converter={StaticResource TypeToVisConverter}}">
                        <TextBlock VerticalAlignment="Center" Text="Max. LONG attemps per day: " />
                        <controls:NumericUpDown Value="{Binding MaxLongAttemps}" 
                                    MinValue="1" Increment="1" Margin="5, 0" Width="70"
                                    MaxValue="100" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="10,3,3,3"
                                Visibility="{Binding DataContext.SelectedItem, ElementName=scriptTabView, Converter={StaticResource TypeToVisConverter}}">
                        <TextBlock VerticalAlignment="Center" Text="Max. SHORT attemps per day: " />
                        <controls:NumericUpDown Value="{Binding MaxShortAttemps}" 
                                    MinValue="1" Increment="1" Margin="5, 0" Width="70"
                                    MaxValue="100" />
                    </StackPanel>
                    <StackPanel HorizontalAlignment="Stretch" Margin="10,3,3,3" 
                                Visibility="{Binding DataContext.SelectedItem, ElementName=scriptTabView, Converter={StaticResource TypeToVisRevConverter}}"
                                IsEnabled="{Binding DataContext.SelectedItem, ElementName=scriptTabView, 
                                Converter={StaticResource ParentValueToEnabledConverter}, ConverterParameter=AllowMultiLong$chkMultiLong}">
                        <CheckBox Name="chkMultiLong" IsChecked="{Binding AllowMultiLong}" Click="cb_Checked" >
                            <TextBlock Text="Allow multiple long entries" />
                        </CheckBox>
                        <StackPanel Visibility="{Binding IsChecked, ElementName=chkMultiLong, Converter={StaticResource BoolToVisbilityConverter}}"
                                    Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="20,3,3,3">
                            <TextBlock VerticalAlignment="Center" Text="Max. long entries: " />
                            <controls:NumericUpDown Value="{Binding MaxLongOpen}" 
                                    MinValue="1" Increment="1" Margin="5, 0" Width="70"
                                    MaxValue="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                    Converter={StaticResource ParentValueToMaxValueConverter},
                                    ConverterParameter=MaxLongOpen$3000}" />
                        </StackPanel>
                    </StackPanel>
                    <StackPanel HorizontalAlignment="Stretch" Margin="10,3,3,3"
                                Visibility="{Binding DataContext.SelectedItem, ElementName=scriptTabView, Converter={StaticResource TypeToVisRevConverter}}"
                                IsEnabled="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                Converter={StaticResource ParentValueToEnabledConverter}, ConverterParameter=AllowMultiShort$chkMultiShort}">
                        <CheckBox Name="chkMultiShort" IsChecked="{Binding AllowMultiShort}" Click="cb_Checked" >
                            <TextBlock Text="Allow multiple short entries" />
                        </CheckBox>
                        <StackPanel Visibility="{Binding IsChecked, ElementName=chkMultiShort, Converter={StaticResource BoolToVisbilityConverter}}"
                                    Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="20,3,3,3">
                            <TextBlock VerticalAlignment="Center" Text="Max. short entries: " />
                            <controls:NumericUpDown Value="{Binding MaxShortOpen}" 
                                    MinValue="1" Increment="1" Margin="5, 0" Width="70"
                                    MaxValue="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                    Converter={StaticResource ParentValueToMaxValueConverter},
                                    ConverterParameter=MaxShortOpen$3000}" />
                        </StackPanel>
                    </StackPanel>
                    <!--
                    <StackPanel HorizontalAlignment="Stretch" Margin="10,3,3,3"
                                IsEnabled="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                Converter={StaticResource ParentValueToEnabledConverter}, ConverterParameter=AllowReEntry$chkReEntry}">
                        <CheckBox Name="chkReEntry" IsChecked="{Binding AllowReEntry}" Click="cb_Checked" >
                            <TextBlock Text="Allow re-entry after previous attemps failed in day trade" />
                        </CheckBox>
                        <StackPanel Visibility="{Binding IsChecked, ElementName=chkReEntry, Converter={StaticResource BoolToVisbilityConverter}}"
                                    Orientation="Vertical" HorizontalAlignment="Stretch" Margin="20,3,3,3">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch">
                                <TextBlock VerticalAlignment="Center" Text="Max. no. of attemps: " />
                                <controls:NumericUpDown Value="{Binding MaxReEntry}" 
                                    MinValue="0" Increment="1" Margin="5, 0" Width="70"
                                    MaxValue="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                    Converter={StaticResource ParentValueToMaxValueConverter},
                                    ConverterParameter=MaxReEntry$10}" />
                                <TextBlock VerticalAlignment="Center" Text="(0 means unlimited)" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="0,6,0,3">
                                <TextBlock VerticalAlignment="Center" Text="Re-enter must occur before: " />
                                <controls:DateTimeEditor Value="{Binding ReEntryBefore}"
                                                                Format="HH:mm:ss" Margin="5, 0" Width="70" Height="22"
                                                                VerticalAlignment="Center"/>
                                <CheckBox VerticalAlignment="Center" Margin="5, 0" IsChecked="{Binding IsNextDay}" >
                                    <TextBlock Text="Next day" />
                                </CheckBox>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>-->
                    <StackPanel HorizontalAlignment="Stretch" Margin="10,3,3,3">
                        <CheckBox IsChecked="{Binding ReverseSignalForcesExit}" >
                            <TextBlock Text="Reverse signal force exit" />
                        </CheckBox>
                    </StackPanel>
                    <StackPanel HorizontalAlignment="Stretch" Orientation="Horizontal" Margin="10,3,3,3">
                        <TextBlock VerticalAlignment="Center" Text="PositionSize"/>
                        <controls:NumericUpDown Value="{Binding DefaultPositionSize}" 
                                    MinValue="1" Increment="1" Margin="5, 0" Width="70"
                                    MaxValue="1000" />
                    </StackPanel>

                    <StackPanel HorizontalAlignment="Stretch" Margin="3" Background="LightGray">
                        <TextBlock Text="Order Options" Margin="3" FontWeight="Bold"/>
                    </StackPanel>

                    <!-- select order type from difference brokers -->
                    <DockPanel LastChildFill="True" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                        <TextBlock DockPanel.Dock="Left" VerticalAlignment="Center" Text="Select Broker: " />
                        <ComboBox x:Name="cmbVendorOrderType" DockPanel.Dock="Right" ItemsSource="{Binding DataContext.VendorOrderTypes, ElementName=scriptTabView}"
                                          DisplayMemberPath="Name" SelectedValuePath="OrderTypes"
                                          SelectedItem="{Binding SelectedVendor, Mode=TwoWay}"
                                          />
                    </DockPanel>

                    <Grid Margin="10,3,3,3">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <!-- options for long entries -->
                        <ContentControl DataContext="{Binding SelectedItem.OrderTypes, ElementName=cmbVendorOrderType}" Content="{Binding}">
                            <ContentControl.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <StackPanel HorizontalAlignment="Stretch" Margin="3" Background="LightGray">
                                            <TextBlock Text="Long Entry Options" Margin="3" FontWeight="Bold"/>
                                        </StackPanel>

                                        <!-- buy options -->
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="7,3,3,3" Background="LightGray">
                                            <local:IconBlock Icon="ArrowRightBoldBoxOutline" Foreground="Green" FontSize="17" Margin="3, 0"/>
                                            <TextBlock Text="Buy Options" Margin="3" FontWeight="Bold"/>
                                        </StackPanel>
                                        <DockPanel LastChildFill="True" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                                            <TextBlock DockPanel.Dock="Left" VerticalAlignment="Center" Text="Order Type: " />
                                            <ComboBox Name="cmbBuyOT" DockPanel.Dock="Right" ItemsSource="{Binding}"
                                                            DisplayMemberPath="Name">
                                                <ComboBox.SelectedItem>
                                                    <MultiBinding Converter="{StaticResource OrderTypesToItem}" Mode="OneWay">
                                                        <Binding Path="DataContext.SelectedItem.BuyOrderTypes" ElementName="scriptTabView"/>
                                                        <Binding Path="SelectedValue" ElementName="cmbVendorOrderType"/>
                                                    </MultiBinding>
                                                </ComboBox.SelectedItem>
                                            </ComboBox>
                                        </DockPanel>
                                        <ContentControl Content="{Binding}" >
                                            <ContentControl.DataContext>
                                                <MultiBinding Converter="{StaticResource RealOrderTypeConverter}" ConverterParameter="Buy">
                                                    <Binding Path="SelectedItem" ElementName="cmbBuyOT"/>
                                                    <Binding Path="DataContext.SelectedItem.BuyOrderTypes" ElementName="scriptTabView" />
                                                    <Binding Path="DataContext" ElementName="scriptTabView" />
                                                </MultiBinding>
                                            </ContentControl.DataContext>
                                            <ContentControl.ContentTemplate>
                                                <DataTemplate>
                                                    <ContentPresenter Content="{Binding}"
                                                                  ContentTemplateSelector="{StaticResource OrderTypeDetailSelector}" />
                                                </DataTemplate>
                                            </ContentControl.ContentTemplate>
                                        </ContentControl>

                                        <!-- copy buttons -->
                                        <Separator />
                                        <StackPanel HorizontalAlignment="Center" Orientation="Horizontal">
                                            <Button Margin="5" HorizontalAlignment="Center" Width="120" 
                                                    Command="{Binding DataContext.Commands.CopyOrderSetup, ElementName=scriptTabView}"
                                                    CommandParameter="{Binding ElementName=scriptTabView, 
                                                        Converter={StaticResource ParametersHandlerConverter},
                                                        ConverterParameter=Sell$Buy}">
                                                <StackPanel Orientation="Horizontal">
                                                    <local:IconBlock HorizontalAlignment="Center" Icon="ArrowExpandUp" FontSize="17"/>
                                                    <TextBlock Text="Copy Upward" Margin="3"/>
                                                </StackPanel>
                                            </Button>
                                            <Button Margin="5" HorizontalAlignment="Center" Width="120" 
                                                    Command="{Binding DataContext.Commands.CopyOrderSetup, ElementName=scriptTabView}"
                                                    CommandParameter="{Binding ElementName=scriptTabView, 
                                                        Converter={StaticResource ParametersHandlerConverter},
                                                        ConverterParameter=Buy$Sell}">
                                                <StackPanel Orientation="Horizontal">
                                                    <local:IconBlock HorizontalAlignment="Center" Icon="ArrowExpandDown" FontSize="17"/>
                                                    <TextBlock Text="Copy Downward" Margin="3"/>
                                                </StackPanel>
                                            </Button>
                                        </StackPanel>

                                        <!-- sell options -->
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="7,3,3,3" Background="LightGray">
                                            <local:IconBlock Icon="ArrowLeftBoldBoxOutline" Foreground="Blue" FontSize="17" Margin="3, 0"/>
                                            <TextBlock Text="Sell Options" Margin="3" FontWeight="Bold"/>
                                        </StackPanel>
                                        <DockPanel LastChildFill="True" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                                            <TextBlock DockPanel.Dock="Left" VerticalAlignment="Center" Text="Order Type: " />
                                            <ComboBox Name="cmbSellOT" DockPanel.Dock="Right" ItemsSource="{Binding}"
                                                            DisplayMemberPath="Name">
                                                <ComboBox.SelectedItem>
                                                    <MultiBinding Converter="{StaticResource OrderTypesToItem}" Mode="OneWay">
                                                        <Binding Path="DataContext.SelectedItem.SellOrderTypes" ElementName="scriptTabView"/>
                                                        <Binding Path="SelectedValue" ElementName="cmbVendorOrderType"/>
                                                    </MultiBinding>
                                                </ComboBox.SelectedItem>
                                            </ComboBox>
                                        </DockPanel>
                                        <ContentControl Content="{Binding}">
                                            <ContentControl.DataContext>
                                                <MultiBinding Converter="{StaticResource RealOrderTypeConverter}" ConverterParameter="Sell">
                                                    <Binding Path="SelectedItem" ElementName="cmbSellOT"/>
                                                    <Binding Path="DataContext.SelectedItem.SellOrderTypes" ElementName="scriptTabView" />
                                                    <Binding Path="DataContext" ElementName="scriptTabView" />
                                                </MultiBinding>
                                            </ContentControl.DataContext>
                                            <ContentControl.ContentTemplate>
                                                <DataTemplate>
                                                    <ContentPresenter Content="{Binding}"
                                                                  ContentTemplateSelector="{StaticResource OrderTypeDetailSelector}" />
                                                </DataTemplate>
                                            </ContentControl.ContentTemplate>
                                        </ContentControl>

                                        <!--Adaptive Profit Stop Settings-->
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="7,3,3,3" Background="LightGray">
                                            <CheckBox IsChecked="{Binding DataContext.SelectedItem.IsAPSAppliedforLong, ElementName=scriptTabView}"
                                                      VerticalAlignment="Center" Margin="3, 0"/>
                                            <TextBlock Text="Enable Adaptive Profit Trailing Stops" Margin="3" FontWeight="Bold"/>
                                        </StackPanel>
                                        <StackPanel Margin="10,3,3,3" HorizontalAlignment="Stretch">
                                            <StackPanel Margin="3" Orientation="Horizontal">
                                                <TextBlock Margin="0, 0, 3, 0">Order Submit Trigger Threshold</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.Threshold, ElementName=scriptTabView}"
                                                                        MaxValue="200" MinValue="0" Increment="1" Width="80"
                                                                        ToolTip="Define how close to target price (in price)"/>
                                            </StackPanel>
                                            <DockPanel LastChildFill="True">
                                                <Separator Width="10" />
                                                <TextBlock Text="Stop Loss" FontWeight="SemiBold" DockPanel.Dock="Left" Margin="3, 0"/>
                                                <Separator HorizontalAlignment="Stretch" />
                                            </DockPanel>
                                            <StackPanel Margin="3">
                                                <TextBlock Text="Hint: 0 means disabled" Margin="0, 2"/>
                                                <StackPanel Orientation="Horizontal">
                                                    <ComboBox ItemsSource="{Binding DataContext.StopLossSource, ElementName=scriptTabView}"
                                                              SelectedIndex="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.StoplossSelector, ElementName=scriptTabView}"/>
                                                    <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.Stoploss, ElementName=scriptTabView}"
                                                                            MaxValue="1000" MinValue="0" Increment="1" Width="50" Margin="3, 0"
                                                                            Visibility="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.StoplossSelector, ElementName=scriptTabView,
                                                                                        Converter={StaticResource StoplossComboToVisConverter}, ConverterParameter=0}"/>
                                                    <TextBlock Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.StoplossAFL, ElementName=scriptTabView,
                                                                        Converter={StaticResource ATAflToNameConverter}}"
                                                               Padding="3, 1" Margin="3, 0"
                                                               VerticalAlignment="Stretch"
                                                               Background="LightGoldenrodYellow"
                                                               Visibility="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.StoplossSelector, ElementName=scriptTabView,
                                                                        Converter={StaticResource StoplossComboToVisConverter}, ConverterParameter=1}"/>
                                                </StackPanel>
                                            </StackPanel>
                                            <DockPanel LastChildFill="True">
                                                <Separator Width="10" />
                                                <TextBlock Text="Profit Trailing Stop" FontWeight="SemiBold" DockPanel.Dock="Left" Margin="3, 0"/>
                                                <Separator HorizontalAlignment="Stretch" />
                                            </DockPanel>
                                            <StackPanel Margin="3" Orientation="Horizontal">
                                                <TextBlock Margin="0, 0, 3, 0">Profit stop levels</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.Level, ElementName=scriptTabView}"
                                                                        MaxValue="5" MinValue="0" Increment="1" Width="50"/>
                                                <TextBlock Margin="3, 0">(0 means disabled)</TextBlock>
                                            </StackPanel>
                                            <StackPanel Margin="3" Orientation="Horizontal">
                                                <TextBlock Margin="0, 0, 3, 0">Profit Base Target(perc)</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.ProfitTarget, ElementName=scriptTabView}"
                                                                        MaxValue="500" MinValue="0" Increment="0.1" Width="40"
                                                                        ToolTip="Only if this target is reached, the stop mechanism will be triggered" />
                                                <TextBlock Margin="3, 0" >Increment</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.TargetIncrement , ElementName=scriptTabView}"
                                                                        MaxValue="2" MinValue="0" Increment="0.1" Width="40"
                                                                        ToolTip="Increment of trigger level: multiplier of target, value from 0.1 to 2"/>
                                            </StackPanel>
                                            <StackPanel Margin="3" Orientation="Horizontal">
                                                <TextBlock Margin="0, 0, 3, 0">Base Line(perc)</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.BaseLine, ElementName=scriptTabView}"
                                                                        MaxValue="90" MinValue="1" Increment="1" Width="40"
                                                                        ToolTip="After reaching a trigger price, order will be submitted only if dropping down from highest profit" />
                                                <TextBlock Margin="3, 0">Increment</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.DropIncrement , ElementName=scriptTabView}"
                                                                        MaxValue="80" MinValue="1" Increment="1" Width="40"
                                                                        ToolTip="Increment of dropping-down level, higher trigger level, smaller dropping-down level" />
                                            </StackPanel>
                                            <GroupBox Header="Information">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="auto"/>
                                                        <RowDefinition Height="auto"/>
                                                        <RowDefinition Height="auto"/>
                                                        <RowDefinition Height="auto"/>
                                                        <RowDefinition Height="auto"/>
                                                    </Grid.RowDefinitions>
                                                    <TextBlock Margin="2" Text="Highest Profit" Grid.Column="0" Grid.Row="0"/>
                                                    <TextBlock Margin="2" Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.HighestProfit, 
                                                                                    ElementName=scriptTabView, StringFormat={}{0:0.######}}" 
                                                               Grid.Column="1" Grid.Row="0" Background="WhiteSmoke"/>
                                                    <TextBlock Margin="2" Text="Profit Class" Grid.Column="0" Grid.Row="1"/>
                                                    <TextBlock Margin="2" Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.ProfitClass, ElementName=scriptTabView}" 
                                                               Grid.Column="1" Grid.Row="1" Background="WhiteSmoke"/>
                                                    <TextBlock Margin="2" Text="Stop Price" Grid.Column="0" Grid.Row="2"/>
                                                    <TextBlock Margin="2" Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.StopPrice, ElementName=scriptTabView, StringFormat={}{0:0.######}}" 
                                                               Grid.Column="1" Grid.Row="2" Background="WhiteSmoke"/>
                                                    <TextBlock Margin="2" Text="Entry Price" Grid.Column="0" Grid.Row="3"/>
                                                    <TextBlock Margin="2" Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.EntryPrice, ElementName=scriptTabView, StringFormat={}{0:0.######}}" 
                                                               Grid.Column="1" Grid.Row="3" Background="WhiteSmoke"/>
                                                    <TextBlock Margin="2" Text="Current Price" Grid.Column="0" Grid.Row="4"/>
                                                    <TextBlock Margin="2" Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforLong.CurPrice, ElementName=scriptTabView, StringFormat={}{0:0.######}}" 
                                                               Grid.Column="1" Grid.Row="4" Background="WhiteSmoke"/>
                                                </Grid>
                                            </GroupBox>
                                        </StackPanel>
                                        <!--End of Adaptive Profit Stop Settings-->

                                        <!--Force Exit Settings-->
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="7,3,3,3" Background="LightGray">
                                            <CheckBox IsChecked="{Binding DataContext.SelectedItem.IsForcedExitForLong, ElementName=scriptTabView}"
                                                      VerticalAlignment="Center" Margin="3, 0"/>
                                            <TextBlock Text="Enable force-exit all open positions" Margin="3" FontWeight="Bold"/>
                                        </StackPanel>
                                        <StackPanel Margin="10,3,3,3" HorizontalAlignment="Stretch">
                                            <StackPanel Orientation="Horizontal" Margin="3">
                                                <TextBlock Text="Apply to" Margin="0, 0 , 3, 0"/>
                                                <xctk:CheckComboBox x:Name="_combo" 
                                                     Width="200"
                                                     HorizontalAlignment="Center" 
                                                     VerticalAlignment="Center" 
                                                     DisplayMemberPath="Name"
                                                     ValueMemberPath="Value"
                                                     SelectedItemsOverride="{Binding DataContext.SelectedItem.ForceExitOrderForLong.Days, ElementName=scriptTabView}"
                                                     ItemsSource="{Binding DataContext.Weekdays, ElementName=scriptTabView}" />
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="3">
                                                <TextBlock Text="End Time" Margin="0, 0 , 3, 0"/>
                                                <controls:DateTimeEditor 
                                                    Value="{Binding DataContext.SelectedItem.ForceExitOrderForLong.FinalTime, ElementName=scriptTabView,
                                                    Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                    Format="HH:mm:ss" Width="70"
                                                    />
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="3">
                                                <TextBlock Text="Limit Order Submmit Time" Margin="0, 0 , 3, 0"/>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.ForceExitOrderForLong.LmtOrderTime, ElementName=scriptTabView}"
                                                                        MaxValue="100" MinValue="0" Increment="1" Width="70" />
                                            </StackPanel>
                                            <TextBlock Text="(How many seconds before End Time)" Margin="3, 0, 3, 3"/>
                                            <StackPanel Orientation="Horizontal" Margin="3">
                                                <TextBlock Text="Slippage" Margin="0, 0 , 3, 0"/>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.ForceExitOrderForLong.Slippage, ElementName=scriptTabView}"
                                                                        MaxValue="10" MinValue="0" Increment="1" Width="70" />
                                            </StackPanel>
                                        </StackPanel>
                                        <!--Force Exit Settings-->
                                        
                                    </StackPanel>
                                </DataTemplate>
                            </ContentControl.ContentTemplate>
                        </ContentControl>
                        <!-- disabled shadow for long UI -->
                        <StackPanel Name="spLongUIShadow" Visibility="{Binding Path=., Converter={StaticResource ActionTypeToLongUIVisConverter}}" 
                                            Background="DimGray" Opacity="0.8"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Stretch"
                                            />
                        <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Grid.Column="1" />

                        <!-- options for short entries -->
                        <ContentControl DataContext="{Binding SelectedValue, ElementName=cmbVendorOrderType}" Content="{Binding}" Grid.Column="2">
                            <ContentControl.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <StackPanel HorizontalAlignment="Stretch" Margin="3" Background="LightGray">
                                            <TextBlock Text="Short Entry Options" Margin="3" FontWeight="Bold"/>
                                        </StackPanel>

                                        <!-- short options -->
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="7,3,3,3" Background="LightGray">
                                            <local:IconBlock Icon="ArrowRightBoldBoxOutline" Foreground="Green" FontSize="17" Margin="3, 0"/>
                                            <TextBlock Text="Short Options" Margin="3" FontWeight="Bold"/>
                                        </StackPanel>
                                        <DockPanel LastChildFill="True" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                                            <TextBlock DockPanel.Dock="Left" VerticalAlignment="Center" Text="Order Type: " />
                                            <ComboBox Name="cmbShortOT" DockPanel.Dock="Right" ItemsSource="{Binding}"
                                                            DisplayMemberPath="Name">
                                                <ComboBox.SelectedItem>
                                                    <MultiBinding Converter="{StaticResource OrderTypesToItem}" Mode="OneWay">
                                                        <Binding Path="DataContext.SelectedItem.ShortOrderTypes" ElementName="scriptTabView"/>
                                                        <Binding Path="SelectedValue" ElementName="cmbVendorOrderType"/>
                                                    </MultiBinding>
                                                </ComboBox.SelectedItem>
                                            </ComboBox>
                                        </DockPanel>
                                        <ContentControl Content="{Binding}" >
                                            <!-- RealOrderTypeConverter will add SelectedItem to OrderTypes -->
                                            <ContentControl.DataContext>
                                                <MultiBinding Converter="{StaticResource RealOrderTypeConverter}" ConverterParameter="Short">
                                                    <Binding Path="SelectedItem" ElementName="cmbShortOT"/>
                                                    <Binding Path="DataContext.SelectedItem.ShortOrderTypes" ElementName="scriptTabView" />
                                                    <Binding Path="DataContext" ElementName="scriptTabView" />
                                                </MultiBinding>
                                            </ContentControl.DataContext>
                                            <ContentControl.ContentTemplate>
                                                <DataTemplate>
                                                    <ContentPresenter Content="{Binding}"
                                                                  ContentTemplateSelector="{StaticResource OrderTypeDetailSelector}" />
                                                </DataTemplate>
                                            </ContentControl.ContentTemplate>
                                        </ContentControl>

                                        <!-- copy buttons -->
                                        <Separator />
                                        <StackPanel HorizontalAlignment="Center" Orientation="Horizontal">
                                            <Button Margin="5" HorizontalAlignment="Center" Width="120"
                                                    Command="{Binding DataContext.Commands.CopyOrderSetup, ElementName=scriptTabView}"
                                                    CommandParameter="{Binding ElementName=scriptTabView, 
                                                        Converter={StaticResource ParametersHandlerConverter},
                                                        ConverterParameter=Cover$Short}">
                                                <StackPanel Orientation="Horizontal">
                                                    <local:IconBlock HorizontalAlignment="Center" Icon="ArrowExpandUp" FontSize="17"/>
                                                    <TextBlock Text="Copy Upward" Margin="3"/>
                                                </StackPanel>
                                            </Button>
                                            <Button Margin="5" HorizontalAlignment="Center" Width="120"
                                                    Command="{Binding DataContext.Commands.CopyOrderSetup, ElementName=scriptTabView}"
                                                    CommandParameter="{Binding ElementName=scriptTabView, 
                                                        Converter={StaticResource ParametersHandlerConverter},
                                                        ConverterParameter=Short$Cover}">
                                                <StackPanel Orientation="Horizontal">
                                                    <local:IconBlock HorizontalAlignment="Center" Icon="ArrowExpandDown" FontSize="17"/>
                                                    <TextBlock Text="Copy Downward" Margin="3"/>
                                                </StackPanel>
                                            </Button>
                                        </StackPanel>

                                        <!-- cover options -->
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="7,3,3,3" Background="LightGray">
                                            <local:IconBlock Icon="ArrowLeftBoldBoxOutline" Foreground="Blue" FontSize="17" Margin="3, 0"/>
                                            <TextBlock Text="Cover Options" Margin="3" FontWeight="Bold"/>
                                        </StackPanel>
                                        <DockPanel LastChildFill="True" HorizontalAlignment="Stretch" Margin="10,3,3,3">
                                            <TextBlock DockPanel.Dock="Left" VerticalAlignment="Center" Text="Order Type: " />
                                            <ComboBox Name="cmbCoverOT" DockPanel.Dock="Right" ItemsSource="{Binding}"
                                                            DisplayMemberPath="Name">
                                                <ComboBox.SelectedItem>
                                                    <MultiBinding Converter="{StaticResource OrderTypesToItem}" Mode="OneWay">
                                                        <Binding Path="DataContext.SelectedItem.CoverOrderTypes" ElementName="scriptTabView"/>
                                                        <Binding Path="SelectedValue" ElementName="cmbVendorOrderType"/>
                                                    </MultiBinding>
                                                </ComboBox.SelectedItem>
                                            </ComboBox>
                                        </DockPanel>
                                        <ContentControl Content="{Binding}" >
                                            <ContentControl.DataContext>
                                                <MultiBinding Converter="{StaticResource RealOrderTypeConverter}" ConverterParameter="Cover">
                                                    <Binding Path="SelectedItem" ElementName="cmbCoverOT"/>
                                                    <Binding Path="DataContext.SelectedItem.CoverOrderTypes" ElementName="scriptTabView" />
                                                    <Binding Path="DataContext" ElementName="scriptTabView" />
                                                </MultiBinding>
                                            </ContentControl.DataContext>
                                            <ContentControl.ContentTemplate>
                                                <DataTemplate>
                                                    <ContentPresenter Content="{Binding}"
                                                                  ContentTemplateSelector="{StaticResource OrderTypeDetailSelector}" />
                                                </DataTemplate>
                                            </ContentControl.ContentTemplate>
                                        </ContentControl>

                                        <!--Adaptive Profit Stop Settings-->
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="7,3,3,3" Background="LightGray">
                                            <CheckBox IsChecked="{Binding DataContext.SelectedItem.IsAPSAppliedforShort, ElementName=scriptTabView}"
                                                      VerticalAlignment="Center" Margin="3, 0"/>
                                            <TextBlock Text="Enable Adaptive Profit Trailing Stops" Margin="3" FontWeight="Bold"/>
                                        </StackPanel>
                                        <StackPanel Margin="10,3,3,3" HorizontalAlignment="Stretch">
                                            <StackPanel Margin="3" Orientation="Horizontal">
                                                <TextBlock Margin="0, 0, 3, 0">Order Submit Trigger Threshold</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.Threshold, ElementName=scriptTabView}"
                                                                        MaxValue="200" MinValue="0" Increment="1" Width="80"
                                                                        ToolTip="Define how close to target price (in price)"/>
                                            </StackPanel>
                                            <DockPanel LastChildFill="True">
                                                <Separator Width="10" />
                                                <TextBlock Text="Stop Loss" FontWeight="SemiBold" DockPanel.Dock="Left" Margin="3, 0"/>
                                                <Separator HorizontalAlignment="Stretch" />
                                            </DockPanel>
                                            <StackPanel Margin="3">
                                                <TextBlock Text="Hint: 0 means disabled" Margin="0, 2"/>
                                                <StackPanel Orientation="Horizontal">
                                                    <ComboBox ItemsSource="{Binding DataContext.StopLossSource, ElementName=scriptTabView}"
                                                              SelectedIndex="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.StoplossSelector, ElementName=scriptTabView}"/>
                                                    <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.Stoploss, ElementName=scriptTabView}"
                                                                            MaxValue="1000" MinValue="0" Increment="1" Width="50" Margin="3, 0"
                                                                            Visibility="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.StoplossSelector, ElementName=scriptTabView,
                                                                                        Converter={StaticResource StoplossComboToVisConverter}, ConverterParameter=0}"/>
                                                    <TextBlock Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.StoplossAFL, ElementName=scriptTabView,
                                                                        Converter={StaticResource ATAflToNameConverter}}"
                                                               Padding="3, 1" Margin="3, 0"
                                                               VerticalAlignment="Stretch"
                                                               Background="LightGoldenrodYellow"
                                                               Visibility="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.StoplossSelector, ElementName=scriptTabView,
                                                                        Converter={StaticResource StoplossComboToVisConverter}, ConverterParameter=1}"/>
                                                </StackPanel>
                                            </StackPanel>
                                            <DockPanel LastChildFill="True">
                                                <Separator Width="10" />
                                                <TextBlock Text="Profit Trailing Stop" FontWeight="SemiBold" DockPanel.Dock="Left" Margin="3, 0"/>
                                                <Separator HorizontalAlignment="Stretch" />
                                            </DockPanel>
                                            <StackPanel Margin="3" Orientation="Horizontal">
                                                <TextBlock Margin="0, 0, 3, 0">Profit stop levels</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.Level, ElementName=scriptTabView}"
                                                                        MaxValue="5" MinValue="0" Increment="1" Width="50"/>
                                                <TextBlock Margin="3, 0">(0 means disabled)</TextBlock>
                                            </StackPanel>
                                            
                                            <StackPanel Margin="3" Orientation="Horizontal">
                                                <TextBlock Margin="0, 0, 3, 0">Profit Base Target(perc)</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.ProfitTarget, ElementName=scriptTabView}"
                                                                        MaxValue="500" MinValue="0" Increment="0.1" Width="40"
                                                                        ToolTip="Only if this target is reached, the stop mechanism will be triggered" />
                                                <TextBlock Margin="3, 0" >Increment</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.TargetIncrement , ElementName=scriptTabView}"
                                                                        MaxValue="2" MinValue="0" Increment="0.1" Width="40"
                                                                        ToolTip="Increment of trigger level: multiplier of target, value from 0.1 to 2"/>
                                            </StackPanel>
                                            <StackPanel Margin="3" Orientation="Horizontal">
                                                <TextBlock Margin="0, 0, 3, 0">Base Line(perc)</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.BaseLine, ElementName=scriptTabView}"
                                                                        MaxValue="90" MinValue="1" Increment="1" Width="40"
                                                                        ToolTip="After reaching a trigger price, order will be submitted only if dropping down from highest profit" />
                                                <TextBlock Margin="3, 0">Increment</TextBlock>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.DropIncrement , ElementName=scriptTabView}"
                                                                        MaxValue="80" MinValue="1" Increment="1" Width="40"
                                                                        ToolTip="Increment of dropping-down level, higher trigger level, smaller dropping-down level" />
                                            </StackPanel>
                                            <GroupBox Header="Information">
                                                <Grid>                                                    
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="auto" />                                                        
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="auto"/>
                                                        <RowDefinition Height="auto"/>
                                                        <RowDefinition Height="auto"/>
                                                        <RowDefinition Height="auto"/>
                                                        <RowDefinition Height="auto"/>
                                                    </Grid.RowDefinitions>
                                                    <TextBlock Margin="2" Text="Entry Price" Grid.Column="0" Grid.Row="3"/>
                                                    <TextBlock Margin="2" Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.EntryPrice, ElementName=scriptTabView, StringFormat={}{0:0.######}}" 
                                                               Grid.Column="1" Grid.Row="3" Background="WhiteSmoke"/>
                                                    <TextBlock Margin="2" Text="Highest Profit" Grid.Column="0" Grid.Row="0"/>
                                                    <TextBlock Margin="2" Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.HighestProfit, 
                                                                                    ElementName=scriptTabView, StringFormat={}{0:0.######}}" 
                                                               Grid.Column="1" Grid.Row="0" Background="WhiteSmoke"/>
                                                    <TextBlock Margin="2" Text="Profit Class" Grid.Column="0" Grid.Row="1"/>
                                                    <TextBlock Margin="2" Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.ProfitClass, ElementName=scriptTabView}" 
                                                               Grid.Column="1" Grid.Row="1" Background="WhiteSmoke"/>
                                                    <TextBlock Margin="2" Text="Stop Price" Grid.Column="0" Grid.Row="2"/>
                                                    <TextBlock Margin="2" Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.StopPrice, ElementName=scriptTabView, StringFormat={}{0:0.######}}" 
                                                               Grid.Column="1" Grid.Row="2" Background="WhiteSmoke"/>
                                                    <TextBlock Margin="2" Text="Current Price" Grid.Column="0" Grid.Row="4"/>
                                                    <TextBlock Margin="2" Text="{Binding DataContext.SelectedItem.AdaptiveProfitStopforShort.CurPrice, ElementName=scriptTabView, StringFormat={}{0:0.######}}" 
                                                               Grid.Column="1" Grid.Row="4" Background="WhiteSmoke"/>
                                                </Grid>
                                            </GroupBox>
                                        </StackPanel>
                                        <!--End of Adaptive Profit Stop Settings-->
                                        
                                        <!--Force Exit Settings-->
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="7,3,3,3" Background="LightGray">
                                            <CheckBox IsChecked="{Binding DataContext.SelectedItem.IsForcedExitForShort, ElementName=scriptTabView}"
                                                      VerticalAlignment="Center" Margin="3, 0"/>
                                            <TextBlock Text="Enable force-exit all open positions" Margin="3" FontWeight="Bold"/>
                                        </StackPanel>
                                        <StackPanel Margin="10,3,3,3" HorizontalAlignment="Stretch">
                                            <StackPanel Orientation="Horizontal" Margin="3">
                                                <TextBlock Text="Apply to" Margin="0, 0 , 3, 0"/>
                                                <xctk:CheckComboBox x:Name="_combo" 
                                                     Width="200"
                                                     HorizontalAlignment="Center" 
                                                     VerticalAlignment="Center" 
                                                     DisplayMemberPath="Name"
                                                     ValueMemberPath="Value"
                                                     SelectedItemsOverride="{Binding DataContext.SelectedItem.ForceExitOrderForShort.Days, ElementName=scriptTabView}"
                                                     ItemsSource="{Binding DataContext.Weekdays, ElementName=scriptTabView}" />
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="3">
                                                <TextBlock Text="End Time" Margin="0, 0 , 3, 0"/>
                                                <controls:DateTimeEditor 
                                                    Value="{Binding DataContext.SelectedItem.ForceExitOrderForShort.FinalTime, ElementName=scriptTabView,
                                                    Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                    Format="HH:mm:ss" Width="70"
                                                    />
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="3">
                                                <TextBlock Text="Limit Order Submmit Time" Margin="0, 0 , 3, 0"/>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.ForceExitOrderForShort.LmtOrderTime, ElementName=scriptTabView}"
                                                                        MaxValue="100" MinValue="0" Increment="1" Width="70" />                                                
                                            </StackPanel>
                                            <TextBlock Text="(How many seconds before End Time)" Margin="3, 0, 3, 3"/>
                                            <StackPanel Orientation="Horizontal" Margin="3">
                                                <TextBlock Text="Slippage (Tick)" Margin="0, 0 , 3, 0"/>
                                                <controls:NumericUpDown Value="{Binding DataContext.SelectedItem.ForceExitOrderForShort.Slippage, ElementName=scriptTabView}"
                                                                        MaxValue="10" MinValue="0" Increment="1" Width="70" />
                                            </StackPanel>
                                        </StackPanel>
                                        <!--Force Exit Settings-->
                                        
                                    </StackPanel>
                                </DataTemplate>
                            </ContentControl.ContentTemplate>
                        </ContentControl>
                        <!-- short UI shadow -->
                        <StackPanel Name="spShortUIShadow" Visibility="{Binding Path=., Converter={StaticResource ActionTypeToShortUIVisConverter}}" 
                                            Background="DimGray" Opacity="0.8"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Stretch"
                                            Grid.Column="2"
                                            />
                        
                    </Grid>

                    <StackPanel HorizontalAlignment="Stretch" Margin="3" Background="LightGray">
                        <TextBlock Text="Selecting Accounts (including sub-accounts)" Margin="3" FontWeight="Bold"/>
                    </StackPanel>

                    <Grid Margin="10,3,3,3" Height="80">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <DockPanel Grid.Column="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                            <TextBlock Text="Select accounts for long entries:" Margin="0, 5" DockPanel.Dock="Top" />
                            <sdl:MultiSelectComboBox Name="mc1" Margin="0,0,5,2" DockPanel.Dock="Bottom" 
                                                     SelectedItemTemplate="{StaticResource MultiSelectComboBox.SelectedItems.Account.ItemTemplate}"
                                                     DropdownItemTemplate="{StaticResource MultiSelectComboBox.Dropdown.ListBox.Account.ItemTemplate}"                                 
                                                     MaxDropDownHeight="200"
                                                     EnableAutoComplete="True"
                                                     ClearFilterOnDropdownClosing="True"
                                                     SelectionMode="Multiple"
                                                     IsEditable="True"                                
                                                     EnableFiltering="True"
                                                     FilterService="{StaticResource CustomFilterService}"
                                                     EnableGrouping="True"
                                                     
                                                     ItemsSource="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                                        Converter={StaticResource SelectedItemToItemSourceConverter}}"
                                                     SelectedItems="{Binding DataContext.SelectedItem.LongAccounts, ElementName=scriptTabView}"
                                                     >
                            </sdl:MultiSelectComboBox>
                        </DockPanel>
                        <!-- long UI shadow -->
                        <StackPanel Visibility="{Binding Path=., Converter={StaticResource ActionTypeToLongUIVisConverter}}" 
                                            Background="DimGray" Opacity="0.8"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Stretch"
                                            />
                        <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Grid.Column="1" />
                        <DockPanel Grid.Column="2" Margin="5, 0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                            <TextBlock Text="Select accounts for short entries:" Margin="0, 5" DockPanel.Dock="Top" />
                            <sdl:MultiSelectComboBox Name="mc2" Margin="0,0,0,2" DockPanel.Dock="Bottom" 
                                                     SelectedItemTemplate="{StaticResource MultiSelectComboBox.SelectedItems.Account.ItemTemplate}"
                                                     DropdownItemTemplate="{StaticResource MultiSelectComboBox.Dropdown.ListBox.Account.ItemTemplate}"                                 
                                                     MaxDropDownHeight="200"
                                                     EnableAutoComplete="True"
                                                     ClearFilterOnDropdownClosing="True"
                                                     SelectionMode="Multiple"
                                                     IsEditable="True"                                
                                                     EnableFiltering="True"
                                                     FilterService="{StaticResource CustomFilterService}"
                                                     EnableGrouping="True"
                                                     ItemsSource="{Binding DataContext.SelectedItem, ElementName=scriptTabView,
                                                        Converter={StaticResource SelectedItemToItemSourceConverter}}"
                                                     SelectedItems="{Binding DataContext.SelectedItem.ShortAccounts, ElementName=scriptTabView}"
                                                     />
                        </DockPanel>
                        <!-- short UI shadow -->
                        <StackPanel Visibility="{Binding Path=., Converter={StaticResource ActionTypeToShortUIVisConverter}}" 
                                            Background="DimGray" Opacity="0.8"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Stretch"
                                            Grid.Column="2"
                                            />
                    </Grid>
                </StackPanel>
            </DataTemplate>
            <!-- end of base DataTemplate for Script/Strategy-->

            <DataTemplate x:Key="DTforScript" DataType="{x:Type om:Script}" >
                <StackPanel>
                    <!-- header -->
                    <DockPanel HorizontalAlignment="Stretch">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="3">
                            <Image Source="{StaticResource optionDrawingImage}" Width="24" />
                            <TextBlock FontSize="16" Margin="5,0,0,0" >
                                        <Run Text="Options for " />
                                        <Run Text="{Binding Path=., Converter={StaticResource TypeToTextConverter}}" />
                                        <Run Text=" " />
                            </TextBlock>
                            <TextBlock Text="{Binding Name, Mode=OneWay}" FontWeight="Bold" FontSize="16" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" DockPanel.Dock="Right" >
                            <TextBlock Text="{Binding DayTradeMode, Converter={StaticResource DayTradeModeToTextConverter}}" 
                                   FontWeight="Bold" FontSize="16" Background="LightGoldenrodYellow" 
                                   Padding="5,0" Margin="0,0,3,0" VerticalAlignment="Center"
                                   />
                        </StackPanel>
                    </DockPanel>

                    <ContentPresenter ContentTemplate="{StaticResource base}" />
                </StackPanel>
            </DataTemplate>

            <DataTemplate x:Key="DTforStrategy" DataType="{x:Type om:Strategy}" >
                <StackPanel>
                    <!-- header -->
                    <DockPanel HorizontalAlignment="Stretch">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="3">
                            <Image Source="{StaticResource optionDrawingImage}" Width="24" />
                            <TextBlock FontSize="16" Margin="5,0,0,0" >
                                        <Run Text="Options for " />
                                        <Run Text="{Binding Path=., Converter={StaticResource TypeToTextConverter}}" />
                                        <Run Text=" " />
                            </TextBlock>
                            <TextBlock Text="{Binding Name, Mode=OneWay}" FontWeight="Bold" FontSize="16" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" DockPanel.Dock="Right" >
                            <TextBlock Text="{Binding ActionType, Converter={StaticResource ActionTypeToTextConverter}}" 
                                       FontWeight="Bold" FontSize="16" Background="Yellow" 
                                       Padding="5,0" Margin="0,0,3,0" VerticalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" DockPanel.Dock="Right" >
                            <TextBlock Text="{Binding DayTradeMode, Converter={StaticResource DayTradeModeToTextConverter}}" 
                                       FontWeight="Bold" FontSize="16" Background="LightGoldenrodYellow" 
                                       Padding="5,0" Margin="0,0,3,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </DockPanel>

                    <ContentPresenter ContentTemplate="{StaticResource base}" />
                </StackPanel>
            </DataTemplate>
            
        </ResourceDictionary>        
    </UserControl.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition MinWidth="150" MaxWidth="400" Width="250" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="auto" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="auto" />
        </Grid.RowDefinitions>
        <GridSplitter Grid.Column="1" Grid.RowSpan="2" HorizontalAlignment="Left" Margin="0, 5" 
                      VerticalAlignment="Stretch" Background="LightGray" Width="3" />
        <TreeView x:Name="MainTreeView" HorizontalAlignment="Stretch"  
                  Grid.Column="0" Grid.Row="0" Grid.RowSpan="2" Margin="5, 5, 0, 5"
                  VerticalAlignment="Stretch" ItemsSource="{Binding SymbolInActions}"                  
                  PreviewMouseRightButtonDown="OnPreviewMouseRightButtonDown">
            <e:Interaction.Behaviors>
                <local:BindableSelectedItemBehavior SelectedItem="{Binding SelectedItem, Mode=TwoWay}" />
            </e:Interaction.Behaviors>
            <TreeView.ItemContainerStyle>
                <Style TargetType="{x:Type TreeViewItem}">
                    <Setter Property="FontWeight" Value="Normal" />
                    <Style.Triggers>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="FontWeight" Value="Bold" />
                        </Trigger>
                    </Style.Triggers>
                    <Style.Resources>
                        <SolidColorBrush x:Key="{x:Static SystemColors.ControlBrushKey}" Color="{x:Static SystemColors.HighlightColor}" Opacity=".4" />
                    </Style.Resources>
                </Style>
            </TreeView.ItemContainerStyle>
            <TreeView.Resources>
                <ContextMenu x:Key="tv_Menu">
                    <MenuItem Header="{Binding IsEnabled, Converter={StaticResource EnabledToMenuTextConverter}}"
                            Icon="{Binding IsEnabled, Converter={StaticResource EnabledToIconConverter}}"
                            Command="{Binding Data.Commands.EnableScriptExecution, Source={StaticResource Proxy}}"
                            CommandParameter="{Binding Data.SelectedItem, Source={StaticResource Proxy}}"
                            />
                    <MenuItem Header="Close Positions"
                            Command="{Binding Data.Commands.CloseCurrentOpenOrders, Source={StaticResource Proxy}}"
                            CommandParameter="{Binding Data.SelectedItem, Source={StaticResource Proxy}}">
                        <MenuItem.Icon>
                            <Image Source="{StaticResource closeCurrentDrawingImage}"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="Refresh parameters"
                            Icon="{Binding Data.ImageRefresh, Source={StaticResource Proxy}}"
                            Command="{Binding Data.Commands.RefreshParameters, Source={StaticResource Proxy}}"
                            CommandParameter="{Binding Data.SelectedItem, Source={StaticResource Proxy}}"/>
                    <MenuItem Header="Remove from list"
                            Command="{Binding Data.Commands.DeleteSymbolInAction, Source={StaticResource Proxy}}"
                            CommandParameter="{Binding Data.SelectedItem, Source={StaticResource Proxy}}">
                        <MenuItem.Icon>
                            <controls:AutoGreyableImage Source="{StaticResource trashDrawingImage}"/>
                        </MenuItem.Icon>
                    </MenuItem>
                            
                </ContextMenu>
                <DataTemplate x:Key="tvItemBase">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto" />
                            <ColumnDefinition Width="auto" />
                            <ColumnDefinition Width="auto" />
                        </Grid.ColumnDefinitions>
                        <Image Source="{Binding Converter={StaticResource SelectedItemToIconConverter}}" 
                               Width="19" Margin="2" />
                        <local:IconBlock Icon="Cancel" FontSize="19" Foreground="Red" Margin="0"
                                         Visibility="{Binding IsEnabled, Converter={StaticResource EnabledToVisConverter}}"/>
                        <StackPanel Orientation="Horizontal" Grid.Column="1"
                                    Visibility="{Binding ShowSign, Converter={StaticResource BoolToVisbilityConverter}}">
                            <local:IconBlock Icon="{Binding IsDirty, Converter={StaticResource IsDirtyToIconConverter}}" 
                                             Foreground="{Binding IsDirty, Converter={StaticResource IsDirtyToColorConverter}}"
                                            VerticalAlignment="Center" FontSize="16"
                                            />
                        </StackPanel>
                    </Grid>
                </DataTemplate>
                <HierarchicalDataTemplate ItemsSource="{Binding Scripts}" DataType="{x:Type om:SymbolInAction}">
                    <StackPanel Orientation="Horizontal"  ContextMenu="{StaticResource tv_Menu}">
                        <ContentPresenter Content="{Binding}"
                                          ContentTemplate="{StaticResource tvItemBase}"/>
                        <Grid>
                            <TextBlock VerticalAlignment="Center" 
                                   Grid.Column="2" IsHitTestVisible="False"
                                   Foreground="{Binding IsEnabled, Converter={StaticResource EnabledToColorConverter}}">
                            <Run Text="{Binding Name}" />
                            <Run Text=" - "/>
                            <Run Text="{Binding TimeFrame}"/>
                            <Run Text="min"/>
                            </TextBlock>
                            <TextBlock Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent"/>
                        </Grid>                        
                    </StackPanel>                    
                </HierarchicalDataTemplate>
                <HierarchicalDataTemplate ItemsSource="{Binding Strategies}" DataType="{x:Type om:Script}">
                    <StackPanel Orientation="Horizontal"  ContextMenu="{StaticResource tv_Menu}">
                        <ContentPresenter Content="{Binding}"
                                          ContentTemplate="{StaticResource tvItemBase}"/>
                        <TextBlock VerticalAlignment="Center" 
                                   Foreground="{Binding IsEnabled, Converter={StaticResource EnabledToColorConverter}}"
                                   Text="{Binding Name, Mode=OneWay}" />
                    </StackPanel>
                </HierarchicalDataTemplate>
                <DataTemplate DataType="{x:Type om:Strategy}">
                    <StackPanel Orientation="Horizontal"  ContextMenu="{StaticResource tv_Menu}">
                        <ContentPresenter Content="{Binding}"
                                          ContentTemplate="{StaticResource tvItemBase}"/>
                        <TextBlock VerticalAlignment="Center" 
                                   Foreground="{Binding IsEnabled, Converter={StaticResource EnabledToColorConverter}}"
                                   Text="{Binding Name, Mode=OneWay}" />
                    </StackPanel>
                </DataTemplate>
                
            </TreeView.Resources>
        </TreeView>
        <ScrollViewer Grid.Column="1" Grid.Row="0" Margin="5" Name="contentSV">
            <local:CachedContentControl DataContext="{Binding SelectedItem}" Contents="{Binding}" />
        </ScrollViewer>
        <StackPanel HorizontalAlignment="Right" Orientation="Horizontal" Grid.Column="1" Grid.Row="1">
            <Button Content="Clear" HorizontalAlignment="Right" Margin="5" Padding="3" Width="80"
                    Command="{Binding Commands.ClearSettings}"
                    CommandParameter="{Binding SelectedItem}"/>
            <Button Content="Apply To Strategies" HorizontalAlignment="Right" Margin="5" Padding="3" Width="120"
                    Visibility="{Binding SelectedItem, Converter={StaticResource TypeToVisRevConverter}}"
                    Command="{Binding Commands.ApplySettingsToStrategy}"
                    CommandParameter="{Binding SelectedItem}"/>
            <Button Content="Load..." HorizontalAlignment="Right" Margin="5" Padding="3" Width="80" 
                    Command="{Binding Commands.OutOpenTemplate}"
                    CommandParameter="{Binding Path=., ElementName=scriptTabView}"/>                        
            <Button Content="Save As..." HorizontalAlignment="Right" Padding="3" Margin="5" Width="80" 
                    Command="{Binding Commands.OutSaveAsTemplate}"
                    CommandParameter="{Binding SelectedItem}"/>
        </StackPanel>        
    </Grid>    
</UserControl>
